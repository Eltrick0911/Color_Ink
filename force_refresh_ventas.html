<!DOCTYPE html>
<html>
<head>
    <title>Forzar ActualizaciÃ³n de Ventas</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 800px; margin: 0 auto; }
        .result { background: #2a2a2a; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        pre { background: #333; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”„ VerificaciÃ³n y ActualizaciÃ³n de Margen de Ventas</h1>
        
        <button onclick="verificarDatos()">ðŸ“Š Verificar Datos Actuales</button>
        <button onclick="limpiarCache()">ðŸ§¹ Limpiar CachÃ©</button>
        <button onclick="recalcularTodo()">ðŸ”„ Recalcular Todo</button>
        
        <div id="results"></div>
    </div>

    <script>
        const API_BASE = '/Color_Ink/public/index.php';
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }
        
        async function verificarDatos() {
            log('ðŸ” Verificando datos actuales de ventas...');
            
            try {
                // Obtener token de sessionStorage
                const token = sessionStorage.getItem('firebase_id_token') || sessionStorage.getItem('access_token');
                
                if (!token) {
                    log('âŒ No hay token de autenticaciÃ³n. Por favor, inicie sesiÃ³n primero.', 'error');
                    return;
                }
                
                const response = await fetch(`${API_BASE}?route=ventas&caso=1&action=listar&_t=${Date.now()}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'OK' && data.data) {
                    const ventas = data.data.filter(v => v.estado === 'REGISTRADA');
                    
                    const totalIngresos = ventas.reduce((acc, v) => acc + parseFloat(v.monto_cobrado || 0), 0);
                    const totalCostos = ventas.reduce((acc, v) => acc + parseFloat(v.costo_total || 0), 0);
                    const totalUtilidad = totalIngresos - totalCostos;
                    const margenReal = totalIngresos > 0 ? (totalUtilidad / totalIngresos * 100) : 0;
                    
                    log(`âœ… Datos obtenidos: ${ventas.length} ventas registradas`, 'success');
                    log(`ðŸ’° Total Ingresos: L${totalIngresos.toFixed(2)}`);
                    log(`ðŸ’¸ Total Costos: L${totalCostos.toFixed(2)}`);
                    log(`ðŸ“ˆ Total Utilidad: L${totalUtilidad.toFixed(2)}`);
                    log(`ðŸ“Š Margen Real: ${margenReal.toFixed(1)}%`, 'success');
                    
                    // Mostrar detalles de cada venta
                    log('<pre>' + JSON.stringify(ventas.map(v => ({
                        id: v.id_venta,
                        monto: parseFloat(v.monto_cobrado),
                        costo: parseFloat(v.costo_total),
                        utilidad: parseFloat(v.utilidad),
                        margen: parseFloat(v.utilidad_pct)
                    })), null, 2) + '</pre>');
                    
                } else {
                    log('âŒ Error en respuesta de API: ' + (data.message || 'Respuesta invÃ¡lida'), 'error');
                }
                
            } catch (error) {
                log('âŒ Error: ' + error.message, 'error');
            }
        }
        
        function limpiarCache() {
            log('ðŸ§¹ Limpiando cachÃ© del navegador...');
            
            // Limpiar localStorage y sessionStorage relacionado con ventas
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key && key.includes('venta')) {
                    localStorage.removeItem(key);
                    log(`ðŸ—‘ï¸ Eliminado de localStorage: ${key}`);
                }
            }
            
            // Forzar recarga de la pÃ¡gina de ventas si estÃ¡ abierta
            if (window.opener) {
                try {
                    window.opener.location.reload();
                    log('ðŸ”„ PÃ¡gina de ventas recargada', 'success');
                } catch (e) {
                    log('âš ï¸ No se pudo recargar la pÃ¡gina de ventas automÃ¡ticamente');
                }
            }
            
            log('âœ… CachÃ© limpiado. Recargue la pÃ¡gina de ventas manualmente.', 'success');
        }
        
        async function recalcularTodo() {
            log('ðŸ”„ Iniciando recÃ¡lculo completo...');
            
            try {
                const token = sessionStorage.getItem('firebase_id_token') || sessionStorage.getItem('access_token');
                
                if (!token) {
                    log('âŒ No hay token de autenticaciÃ³n', 'error');
                    return;
                }
                
                // Llamar al endpoint de recÃ¡lculo de costos
                const response = await fetch(`${API_BASE}?route=ventas&caso=1&action=recalcular-costos`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'OK') {
                    log('âœ… RecÃ¡lculo completado exitosamente', 'success');
                    log('ðŸ”„ Verificando datos actualizados...');
                    setTimeout(verificarDatos, 1000);
                } else {
                    log('âŒ Error en recÃ¡lculo: ' + (result.message || 'Error desconocido'), 'error');
                }
                
            } catch (error) {
                log('âŒ Error en recÃ¡lculo: ' + error.message, 'error');
            }
        }
        
        // Verificar datos al cargar la pÃ¡gina
        window.addEventListener('load', () => {
            log('ðŸš€ Herramienta de verificaciÃ³n cargada');
            log('ðŸ’¡ AsegÃºrese de estar autenticado en la aplicaciÃ³n principal antes de usar estas funciones');
        });
    </script>
</body>
</html>